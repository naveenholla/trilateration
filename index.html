<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Trilateration Simulator - RSSI Edition</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Bluetooth Trilateration Simulator</h1>
            <p class="subtitle">RSSI-to-Distance Conversion | v1.6 (Phase 1: Kalman + Weighted LS) üéØ</p>
        </header>

        <div class="main-content">
            <!-- Left Sidebar: Settings -->
            <aside class="sidebar sidebar-left">
                <div class="panel">
                    <!-- Tab Navigation -->
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="setup">‚öôÔ∏è Setup</button>
                        <button class="tab-btn" data-tab="floor-plan">üó∫Ô∏è Floor Plan</button>
                        <button class="tab-btn" data-tab="walls">üß± Walls</button>
                        <button class="tab-btn" data-tab="advanced">üîß Advanced</button>
                    </div>

                    <!-- Setup Tab -->
                    <div class="tab-content active" data-tab="setup">
                        <h2>RSSI Model</h2>

                        <div class="control-group">
                            <label for="txPower">Tx Power @ 1m (dBm):</label>
                            <input type="number" id="txPower" value="-59" step="1" min="-80" max="-30">
                            <span class="value-display">-59 dBm</span>
                        </div>

                        <div class="control-group">
                            <label for="pathLossExponent">Path Loss Exponent (n):</label>
                            <input type="range" id="pathLossExponent" value="2.7" step="0.1" min="2.0" max="4.0">
                            <span class="value-display">2.7</span>
                            <small>(2.0 = free space, 2.7-3.5 = indoor)</small>
                        </div>

                        <div class="control-group">
                            <label for="minRSSI">Min RSSI Threshold (dBm):</label>
                            <input type="number" id="minRSSI" value="-100" step="5" min="-120" max="-60">
                            <span class="value-display">-100 dBm</span>
                            <small>(Below = no circle)</small>
                        </div>

                        <hr>

                        <h2>Radio Configuration</h2>

                        <div class="control-group">
                            <label for="numRadios">Number of Radios:</label>
                            <select id="numRadios">
                                <option value="3">3 Radios</option>
                                <option value="4" selected>4 Radios</option>
                                <option value="5">5 Radios</option>
                                <option value="6">6 Radios</option>
                            </select>
                        </div>

                        <button id="resetBtn" class="btn-primary">Reset Positions</button>
                    </div>

                    <!-- Floor Plan Tab -->
                    <div class="tab-content" data-tab="floor-plan">
                        <h2>Upload Floor Plan</h2>

                        <div class="control-group">
                            <label for="floorPlanUpload" class="btn-secondary" style="cursor: pointer;">
                                üìÅ Upload Floor Plan Image
                            </label>
                            <input type="file" id="floorPlanUpload" accept="image/*" style="display: none;">
                            <div id="floorPlanInfo" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
                        </div>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="showFloorPlan">
                                Show Floor Plan
                            </label>
                        </div>

                        <div class="control-group">
                            <label for="floorPlanOpacity">Floor Plan Opacity:</label>
                            <input type="range" id="floorPlanOpacity" value="0.5" step="0.05" min="0" max="1">
                            <span class="value-display">0.5</span>
                        </div>

                        <div class="control-group">
                            <label for="floorPlanScale">Floor Plan Scale (px/m):</label>
                            <input type="range" id="floorPlanScale" value="40" step="1" min="10" max="100">
                            <span class="value-display">40</span>
                            <small>(Adjust to match grid)</small>
                        </div>

                        <button id="clearFloorPlanBtn" class="btn-secondary" style="width: 100%;">Clear Floor Plan</button>

                        <hr>

                        <h2>Auto Wall Detection</h2>

                        <div class="control-group">
                            <button id="detectWallsBtn" class="btn-primary" style="width: 100%;" disabled>
                                üîç Detect Walls from Image
                            </button>
                            <small id="opencvStatus" style="color: #999;">Loading OpenCV.js...</small>
                        </div>

                        <!-- Collapsible Advanced Detection Settings -->
                        <div class="collapsible-section">
                            <button class="collapsible-header">
                                <span>Detection Parameters</span>
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                            <div class="collapsible-content">
                                <div class="control-group">
                                    <label for="cannyThreshold1">Edge Threshold 1:</label>
                                    <input type="range" id="cannyThreshold1" value="50" step="10" min="10" max="200">
                                    <span class="value-display">50</span>
                                    <small>(Lower = more edges)</small>
                                </div>

                                <div class="control-group">
                                    <label for="cannyThreshold2">Edge Threshold 2:</label>
                                    <input type="range" id="cannyThreshold2" value="150" step="10" min="50" max="300">
                                    <span class="value-display">150</span>
                                    <small>(Higher = stronger edges only)</small>
                                </div>

                                <div class="control-group">
                                    <label for="houghThreshold">Line Threshold:</label>
                                    <input type="range" id="houghThreshold" value="50" step="5" min="20" max="150">
                                    <span class="value-display">50</span>
                                    <small>(Higher = longer lines only)</small>
                                </div>

                                <div class="control-group">
                                    <label for="minLineLength">Min Line Length (px):</label>
                                    <input type="range" id="minLineLength" value="50" step="10" min="20" max="200">
                                    <span class="value-display">50</span>
                                </div>

                                <div class="control-group">
                                    <label for="maxLineGap">Max Line Gap (px):</label>
                                    <input type="range" id="maxLineGap" value="10" step="5" min="5" max="50">
                                    <span class="value-display">10</span>
                                    <small>(Connect nearby segments)</small>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label for="detectedWallMaterial">Detected Wall Material:</label>
                            <select id="detectedWallMaterial">
                                <option value="drywall" selected>Drywall (3 dB)</option>
                                <option value="concrete">Concrete (10 dB)</option>
                                <option value="brick">Brick (8 dB)</option>
                            </select>
                        </div>

                        <div id="detectionStatus" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
                    </div>

                    <!-- Walls Tab -->
                    <div class="tab-content" data-tab="walls">
                        <h2>Wall Attenuation</h2>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="enableWalls">
                                Enable Wall Attenuation
                            </label>
                        </div>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="showWallIntersections">
                                Show Wall Intersections
                            </label>
                        </div>

                        <!-- Collapsible Advanced Attenuation Settings -->
                        <div class="collapsible-section">
                            <button class="collapsible-header">
                                <span>Advanced Settings</span>
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                            <div class="collapsible-content">
                                <div class="control-group">
                                    <label>
                                        <input type="checkbox" id="enableAngleEffect" checked>
                                        Apply Angle Effect
                                    </label>
                                    <small>(Less loss at shallow angles)</small>
                                </div>

                                <div class="control-group">
                                    <label>
                                        <input type="checkbox" id="enableCumulativeEffect" checked>
                                        Apply Cumulative Effect
                                    </label>
                                    <small>(Each wall adds 10% more loss)</small>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <h2>Wall Editor</h2>

                        <div class="control-group">
                            <button id="drawWallBtn" class="btn-primary" style="width: 100%;">
                                üñäÔ∏è Draw Wall Mode (OFF)
                            </button>
                        </div>

                        <div class="control-group">
                            <label for="wallMaterial">Wall Material:</label>
                            <select id="wallMaterial">
                                <option value="drywall" selected>Drywall (3 dB)</option>
                                <option value="concrete">Concrete (10 dB)</option>
                                <option value="brick">Brick (8 dB)</option>
                                <option value="glass">Glass (2 dB)</option>
                                <option value="metal">Metal (20 dB)</option>
                                <option value="door_wood">Wood Door (4 dB)</option>
                                <option value="door_metal">Metal Door (12 dB)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <button id="deleteWallBtn" class="btn-secondary" style="width: 100%;">
                                üóëÔ∏è Delete Selected Wall
                            </button>
                        </div>

                        <div class="control-group">
                            <button id="clearAllWallsBtn" class="btn-secondary" style="width: 100%;">
                                Clear All Walls
                            </button>
                        </div>

                        <div id="wallEditorInfo" style="font-size: 0.8em; color: #666; margin-top: 10px;">
                            Walls: <span id="wallCount">2</span>
                        </div>
                    </div>

                    <!-- Advanced Tab -->
                    <div class="tab-content" data-tab="advanced">
                        <h2>Noise Simulation</h2>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="enableNoise">
                                Enable RSSI Noise (¬±3-8 dB)
                            </label>
                        </div>

                        <div class="control-group">
                            <label for="noiseLevel">Noise Std Dev (dB):</label>
                            <input type="range" id="noiseLevel" value="5" step="0.5" min="0" max="10" disabled>
                            <span class="value-display">5</span>
                        </div>

                        <hr>

                        <h2>Signal Processing (Phase 1 üéØ)</h2>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="enableKalmanFilter" checked>
                                Enable Kalman Filter
                            </label>
                            <small>(Reduces RSSI noise, improves accuracy 20-40%)</small>
                        </div>

                        <div class="control-group">
                            <label for="kalmanR">Measurement Noise (R):</label>
                            <input type="range" id="kalmanR" value="0.01" step="0.01" min="0.001" max="0.1">
                            <span class="value-display">0.01</span>
                            <small>(Lower = trust measurements more)</small>
                        </div>

                        <div class="control-group">
                            <label for="kalmanQ">Process Noise (Q):</label>
                            <input type="range" id="kalmanQ" value="3" step="0.5" min="0.5" max="10">
                            <span class="value-display">3</span>
                            <small>(Higher = allow faster changes)</small>
                        </div>

                        <div class="info-box" style="background-color: #E3F2FD; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>‚ÑπÔ∏è Weighted Least Squares Active</strong><br>
                            <small>Stronger RSSI signals automatically receive higher weight in position estimation.</small>
                        </div>

                        <hr>

                        <h2>Visualization</h2>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="showDebugLines">
                                Show True Distance Lines (Debug)
                            </label>
                        </div>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="enableHeatmap">
                                Enable RSSI Heatmap
                            </label>
                        </div>
                    </div>
                </div>

                <div class="panel legend">
                    <h3>Legend</h3>
                    <div class="legend-item">
                        <span class="legend-radio"></span> Radio (Tx)
                    </div>
                    <div class="legend-item">
                        <span class="legend-device"></span> Device (Rx)
                    </div>
                    <div class="legend-item">
                        <span class="legend-estimated"></span> Est. Position
                    </div>
                    <div class="legend-item">
                        <span class="legend-true"></span> + True Position
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: rgba(100, 150, 255, 0.3); border: 1px solid rgba(100, 150, 255, 0.6);"></div>
                        Circle = Est. distance from RSSI
                    </div>
                </div>
            </aside>

            <!-- Center: Canvas -->
            <main class="canvas-container">
                <!-- Quick Actions Toolbar -->
                <div class="canvas-toolbar">
                    <div class="toolbar-section">
                        <button id="quickDrawWall" class="toolbar-btn" title="Toggle Draw Wall Mode">
                            <span class="icon">üñäÔ∏è</span>
                            <span class="label">Draw Wall</span>
                        </button>
                        <button id="quickEnableWalls" class="toolbar-btn" title="Toggle Wall Attenuation">
                            <span class="icon">üß±</span>
                            <span class="label">Walls</span>
                        </button>
                        <button id="quickFloorPlan" class="toolbar-btn" title="Toggle Floor Plan">
                            <span class="icon">üó∫Ô∏è</span>
                            <span class="label">Floor Plan</span>
                        </button>
                    </div>
                    <div class="toolbar-section">
                        <button id="quickNoise" class="toolbar-btn" title="Toggle Noise">
                            <span class="icon">üì∂</span>
                            <span class="label">Noise</span>
                        </button>
                        <button id="quickHeatmap" class="toolbar-btn" title="Toggle Heatmap">
                            <span class="icon">üî•</span>
                            <span class="label">Heatmap</span>
                        </button>
                        <button id="quickDebug" class="toolbar-btn" title="Toggle Debug Lines">
                            <span class="icon">üîç</span>
                            <span class="label">Debug</span>
                        </button>
                    </div>
                    <div class="toolbar-section">
                        <button id="quickReset" class="toolbar-btn" title="Reset Positions">
                            <span class="icon">üîÑ</span>
                            <span class="label">Reset</span>
                        </button>
                    </div>
                </div>

                <!-- Mode Indicator -->
                <div id="modeIndicator" class="mode-indicator">
                    <span class="mode-icon">üëÜ</span>
                    <span class="mode-text">Click and drag to move radios and device</span>
                </div>

                <canvas id="mainCanvas" width="800" height="600"></canvas>
                <div id="statusMessage" class="status-message"></div>
            </main>

            <!-- Right Sidebar: Data Table -->
            <aside class="sidebar sidebar-right">
                <div class="panel">
                    <h2>üìä Radio Data</h2>
                    <div id="radioDataTable"></div>
                </div>

                <div class="panel">
                    <h2>üìç Position Data</h2>
                    <div id="positionData"></div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Three.js for 3D rendering -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

    <!-- OpenCV.js for computer vision (wall detection) -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

    <!-- Kalman.js for RSSI filtering -->
    <script src="https://cdn.jsdelivr.net/npm/kalmanjs@1.1.0/kalman.min.js"></script>

    <!-- Main application -->
    <script src="app.js"></script>
</body>
</html>
